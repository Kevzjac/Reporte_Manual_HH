<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Manual de Horas Hombre - Departamento de Producci贸n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eaeaea;
        }
        
        .header-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #2c3e50;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 24px;
        }
        
        .header-text {
            text-align: left;
        }
        
        h1 {
            color: #2c3e50;
            font-size: 28px;
            margin-bottom: 5px;
        }
        
        .company-name {
            font-size: 18px;
            color: #3498db;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 16px;
        }
        
        .sync-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: 10px;
        }
        
        .sync-online {
            background-color: #2ecc71;
            color: white;
        }
        
        .sync-offline {
            background-color: #e74c3c;
            color: white;
        }
        
        .form-section {
            margin-bottom: 25px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        input[type="text"], input[type="time"], select, input[type="password"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input[type="text"]:focus, input[type="time"]:focus, select:focus, input[type="password"]:focus {
            border-color: #3498db;
            outline: none;
            box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
        }
        
        .employee-name {
            margin-top: 15px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 4px solid #3498db;
            font-weight: 500;
            color: #2c3e50;
            min-height: 50px;
            display: flex;
            align-items: center;
        }
        
        .hidden {
            display: none;
        }
        
        .section-container {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }
        
        .section {
            flex: 1;
            padding: 20px;
            border-radius: 8px;
            background-color: #f8f9fa;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-group {
            flex: 1;
        }
        
        .btn-register {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        
        .btn-register:hover {
            background-color: #2980b9;
        }
        
        .disabled {
            opacity: 0.6;
            pointer-events: none;
        }
        
        .section.active {
            border: 2px solid #3498db;
            background-color: #e8f4fc;
        }
        
        .section.locked {
            border: 2px solid #e74c3c;
            background-color: #fdedec;
        }
        
        .lock-indicator {
            display: inline-block;
            margin-left: 10px;
            color: #e74c3c;
            font-size: 14px;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            background-color: #2ecc71;
            color: white;
            border-radius: 5px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .notification.error {
            background-color: #e74c3c;
        }
        
        .notification.warning {
            background-color: #f39c12;
        }
        
        /* Estilos para la secci贸n de consulta */
        .consult-section {
            margin-top: 40px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
        }
        
        .consult-section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #ddd;
        }
        
        .consult-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .consult-controls .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .btn-consult {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .btn-consult:hover {
            background-color: #219653;
        }
        
        .results-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            border-radius: 5px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
        }
        
        .results-table th, .results-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eaeaea;
        }
        
        .results-table th {
            background-color: #3498db;
            color: white;
            font-weight: 600;
        }
        
        .results-table tr:hover {
            background-color: #f5f7fa;
        }
        
        .no-results {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid #ddd;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        
        .tab.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .btn-download {
            background-color: #e67e22;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 15px;
            margin-right: 10px;
        }
        
        .btn-download:hover {
            background-color: #d35400;
        }
        
        .btn-delete {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 15px;
        }
        
        .btn-delete:hover {
            background-color: #c0392b;
        }
        
        .btn-sync {
            background-color: #9b59b6;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: background-color 0.3s;
            margin-top: 15px;
            margin-right: 10px;
        }
        
        .btn-sync:hover {
            background-color: #8e44ad;
        }
        
        .password-prompt {
            margin-top: 20px;
            padding: 15px;
            background-color: #fdedec;
            border: 1px solid #e74c3c;
            border-radius: 5px;
        }
        
        .password-prompt.hidden {
            display: none;
        }
        
        .password-input-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .password-input-group input {
            flex: 1;
        }
        
        .btn-confirm {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .btn-cancel {
            background-color: #7f8c8d;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
        }
        
        .config-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #e8f4fc;
            border-radius: 5px;
            border: 1px solid #3498db;
        }
        
        .config-section h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        @media (max-width: 768px) {
            .section-container {
                flex-direction: column;
            }
            
            .form-row {
                flex-direction: column;
                gap: 10px;
            }
            
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .header-text {
                text-align: center;
            }
            
            .consult-controls {
                flex-direction: column;
            }
            
            .results-table {
                display: block;
                overflow-x: auto;
            }
            
            .password-input-group {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="logo">ET</div>
                <div class="header-text">
                    <div class="company-name">ETec</div>
                    <h1>Reporte Manual de Horas Hombre 
                        <span id="sync-status" class="sync-status sync-online">Sincronizado</span>
                    </h1>
                    <div class="subtitle">Departamento de Producci贸n</div>
                </div>
            </div>
            <p>Soluciones de Ingenier铆a para el Movimiento de Aguas</p>
        </header>
        
        <div class="tabs">
            <div class="tab active" data-tab="registro">Registrar Horas</div>
            <div class="tab" data-tab="consulta">Consultar Registros</div>
            <div class="tab" data-tab="configuracion">Configuraci贸n</div>
        </div>
        
        <div class="tab-content active" id="registro-tab">
            <main>
                <div class="form-section">
                    <label for="employee-id">ID Empleado</label>
                    <input type="text" id="employee-id" placeholder="Ingrese el c贸digo del empleado (E1, E2, etc.)">
                    <div id="employee-name" class="employee-name hidden">
                        <!-- El nombre del empleado aparecer谩 aqu铆 -->
                    </div>
                </div>
                
                <div class="section-container">
                    <div class="section active" id="section-ejecuciones">
                        <h2>Ejecuciones <span id="lock-ejecuciones" class="lock-indicator hidden"></span></h2>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="orden">Orden</label>
                                <input type="text" id="orden" placeholder="N煤mero de orden">
                            </div>
                            <div class="form-group">
                                <label for="sufijo">Sufijo</label>
                                <input type="text" id="sufijo" placeholder="Sufijo">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="operacion">Operaci贸n</label>
                                <input type="text" id="operacion" placeholder="Operaci贸n">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hora-inicio-ejecuciones">Hora Inicio</label>
                                <input type="time" id="hora-inicio-ejecuciones">
                            </div>
                            <div class="form-group">
                                <label for="hora-fin-ejecuciones">Hora Fin</label>
                                <input type="time" id="hora-fin-ejecuciones">
                            </div>
                        </div>
                        <button class="btn-register" id="btn-registrar-ejecuciones">Registrar</button>
                    </div>
                    
                    <div class="section" id="section-indirectos">
                        <h2>Indirectos <span id="lock-indirectos" class="lock-indicator hidden"></span></h2>
                        <div class="form-group">
                            <label for="actividad">Actividad</label>
                            <select id="actividad">
                                <option value="">Seleccione una actividad</option>
                                <option value="5S">5S - PROGRAMA 5S</option>
                                <option value="ALM">ALM - TIEMPO DE ALMUERZO</option>
                                <option value="AMC">AMC - ADMINISTRACIN MESA CORTE</option>
                                <option value="APY">APY - APOYO</option>
                                <option value="AUS">AUS - AUSENCIA INJUSTIFICADA</option>
                                <option value="BVE">BVE - AUSENCIA POR BLOQUEO EN VIAS EXTERNAS</option>
                                <option value="CAP">CAP - CAPACITACIONES</option>
                                <option value="CDO">CDO - CALAMIDAD DOMESTICA</option>
                                <option value="CME">CME - CITAS MEDICAS</option>
                                <option value="COM">COM - COMPENSATORIO</option>
                                <option value="DC">DC - DESCANSO</option>
                                <option value="FEE">FEE - FALLA ENERGA ELECTRICA</option>
                                <option value="FEI">FEI - FALLA EQUIPO DE IZAJE DE CARGAS</option>
                                <option value="FHM">FHM - FABRICACION HERRAMIENTAS MANTENIMIENTO</option>
                                <option value="FHP">FHP - FABRICACION HERRAMIENTAS PRODUCCIN</option>
                                <option value="FMQ">FMQ - FALLA MAQUINA</option>
                                <option value="IAC">IAC - INACTIVIDAD</option>
                                <option value="IDL">IDL - PARO DE MAQUINA</option>
                                <option value="INC">INC - INCAPACIDAD</option>
                                <option value="INV">INV - INVENTARIO</option>
                                <option value="LLI">LLI - LLUVIA O INUNDACIN</option>
                                <option value="MCO">MCO - MTTO CORRECTIVO</option>
                                <option value="MIP">MIP - MOVIMIENTOS INTERNOS PRODUCCIN</option>
                                <option value="MPR">MPR - MTTO PREVENTIVO</option>
                                <option value="MYP">MYP - MODELOS Y PROTOTIPOS</option>
                                <option value="OYA">OYA - ORDEN Y ASEO</option>
                                <option value="PAC">PAC - PAUSA ACTIVA</option>
                                <option value="PER">PER - PERMISO</option>
                                <option value="PL">PL - PINTURA LINEAS DE AREAS</option>
                                <option value="PME">PME - PROYECTO MEJORA</option>
                                <option value="RCI">RCI - REUNIONES - CAPACITACIONES INGENIERA</option>
                                <option value="RCP">RCP - REUNIONES - CAPACITACIONES PRODUCCIN</option>
                                <option value="RCS">RCS - REUNIONES - CAPACITACIONES SOPORTE</option>
                                <option value="RIT">RIT - REUNIN INICIO TURNO</option>
                                <option value="SPR">SPR - SOPORTE PRODUCCIN</option>
                                <option value="SUP">SUP - SUPERVISIN</option>
                                <option value="VAC">VAC - VACACIONES</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="hora-inicio-indirectos">Hora Inicio</label>
                                <input type="time" id="hora-inicio-indirectos">
                            </div>
                            <div class="form-group">
                                <label for="hora-fin-indirectos">Hora Fin</label>
                                <input type="time" id="hora-fin-indirectos">
                            </div>
                        </div>
                        <button class="btn-register" id="btn-registrar-indirectos">Registrar</button>
                    </div>
                </div>
            </main>
        </div>
        
        <div class="tab-content" id="consulta-tab">
            <div class="consult-section">
                <h2>Consultar Registros de Horas</h2>
                <div class="consult-controls">
                    <div class="form-group">
                        <label for="consult-employee">Empleado</label>
                        <select id="consult-employee">
                            <option value="">Todos los empleados</option>
                            <!-- Las opciones se cargar谩n din谩micamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="consult-type">Tipo de Registro</label>
                        <select id="consult-type">
                            <option value="">Todos los tipos</option>
                            <option value="ejecuciones">Ejecuciones</option>
                            <option value="indirectos">Indirectos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="consult-date">Fecha</label>
                        <input type="date" id="consult-date">
                    </div>
                    <button class="btn-consult" id="btn-consultar">Consultar</button>
                </div>
                
                <div id="consult-results">
                    <table class="results-table hidden" id="results-table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Empleado</th>
                                <th>Tipo</th>
                                <th>Detalles</th>
                                <th>Hora Inicio</th>
                                <th>Hora Fin</th>
                            </tr>
                        </thead>
                        <tbody id="results-body">
                            <!-- Los resultados se cargar谩n aqu铆 -->
                        </tbody>
                    </table>
                    <div class="no-results hidden" id="no-results">
                        No se encontraron registros con los criterios seleccionados.
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn-sync" id="btn-sync-now">Sincronizar Ahora</button>
                    <button class="btn-download" id="btn-download-excel">Descargar Excel</button>
                    <button class="btn-delete" id="btn-delete-records">Borrar Todos los Registros</button>
                </div>
                
                <div class="password-prompt hidden" id="password-prompt">
                    <h3>Confirmar Eliminaci贸n</h3>
                    <p>Esta acci贸n eliminar谩 <strong>todos los registros</strong> de forma permanente. Para continuar, ingrese la contrase帽a de administrador:</p>
                    <div class="password-input-group">
                        <input type="password" id="admin-password" placeholder="Contrase帽a de administrador">
                        <button class="btn-confirm" id="btn-confirm-delete">Confirmar</button>
                        <button class="btn-cancel" id="btn-cancel-delete">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="tab-content" id="configuracion-tab">
            <div class="config-section">
                <h3>Configuraci贸n de Sincronizaci贸n</h3>
                <p><strong>Estado actual:</strong> <span id="config-status">Conectado a base de datos centralizada</span></p>
                <p><strong>URL de Google Sheets:</strong> <span id="sheets-url">https://docs.google.com/spreadsheets/d/1ABC123...</span></p>
                <p><strong>ltima sincronizaci贸n:</strong> <span id="last-sync">Hace 2 minutos</span></p>
                <p><strong>Registros almacenados:</strong> <span id="total-records">0 registros</span></p>
                
                <div style="margin-top: 15px;">
                    <button class="btn-sync" id="btn-test-connection">Probar Conexi贸n</button>
                    <button class="btn-download" id="btn-backup-now">Crear Backup</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification">Registro guardado exitosamente</div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elementos del DOM
            const employeeIdInput = document.getElementById('employee-id');
            const employeeNameDiv = document.getElementById('employee-name');
            const sectionEjecuciones = document.getElementById('section-ejecuciones');
            const sectionIndirectos = document.getElementById('section-indirectos');
            const btnRegistrarEjecuciones = document.getElementById('btn-registrar-ejecuciones');
            const btnRegistrarIndirectos = document.getElementById('btn-registrar-indirectos');
            const notification = document.getElementById('notification');
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            const btnConsultar = document.getElementById('btn-consultar');
            const resultsTable = document.getElementById('results-table');
            const resultsBody = document.getElementById('results-body');
            const noResults = document.getElementById('no-results');
            const btnDownloadExcel = document.getElementById('btn-download-excel');
            const btnDeleteRecords = document.getElementById('btn-delete-records');
            const lockEjecuciones = document.getElementById('lock-ejecuciones');
            const lockIndirectos = document.getElementById('lock-indirectos');
            const consultEmployeeSelect = document.getElementById('consult-employee');
            const passwordPrompt = document.getElementById('password-prompt');
            const adminPasswordInput = document.getElementById('admin-password');
            const btnConfirmDelete = document.getElementById('btn-confirm-delete');
            const btnCancelDelete = document.getElementById('btn-cancel-delete');
            const syncStatus = document.getElementById('sync-status');
            const btnSyncNow = document.getElementById('btn-sync-now');
            const btnTestConnection = document.getElementById('btn-test-connection');
            const btnBackupNow = document.getElementById('btn-backup-now');
            const configStatus = document.getElementById('config-status');
            const sheetsUrl = document.getElementById('sheets-url');
            const lastSync = document.getElementById('last-sync');
            const totalRecords = document.getElementById('total-records');
            
            // Variables para controlar el estado de las secciones
            let ejecucionesHasData = false;
            let indirectosHasData = false;
            
            // Base de datos centralizada (Google Sheets simulada)
            let database = [];
            let lastSyncTime = new Date();
            let isOnline = true;
            
            // Configuraci贸n de Google Sheets (simulada)
            const SHEET_ID = '1MDce_9VtK6jGRxrCmuShRZF1Ncon1hc2UQBsTaa1cEo'; // ID ficticio de Google Sheet
            const API_KEY = 'AIzaSyDNtwpKLfXBpkXUN-sID2wrGqevcydvcG0'; // API Key ficticia
            
            // Mapeo completo de c贸digos a nombres
            const employees = {
                'E1': 'Alvarez, Argemiro',
                'E2': 'Cabarcas Cervantes, Carlos',
                'E3': 'Cabrera Anaya, Marlon',
                'E4': 'Carmona Chamorro, Franklin',
                // ... (todos los empleados aqu铆 - se mantiene igual que antes)
                'E204': 'Cardales Navarro, Edgar'
            };
            
            // ==============================
            // FUNCIONES DE SINCRONIZACIN
            // ==============================
            
            // Simular conexi贸n a Google Sheets
            async function syncWithGoogleSheets() {
                try {
                    // Simular delay de red
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                    // En un caso real, aqu铆 ir铆a el c贸digo para conectar con Google Sheets API
                    // const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Registros?key=${API_KEY}`);
                    // const data = await response.json();
                    
                    // Por ahora, simulamos que siempre funciona
                    updateSyncStatus(true);
                    lastSyncTime = new Date();
                    updateLastSyncDisplay();
                    
                    // Cargar datos desde localStorage como respaldo
                    loadFromLocalStorage();
                    
                    return true;
                } catch (error) {
                    console.error('Error de sincronizaci贸n:', error);
                    updateSyncStatus(false);
                    // Cargar datos locales como respaldo
                    loadFromLocalStorage();
                    return false;
                }
            }
            
            // Guardar en Google Sheets (simulado)
            async function saveToCloud(data) {
                try {
                    // Simular env铆o a la nube
                    await new Promise(resolve => setTimeout(resolve, 500));
                    
                    // En un caso real, aqu铆 se enviar铆a el dato a Google Sheets
                    // const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Registros:append?valueInputOption=RAW&key=${API_KEY}`, {
                    //     method: 'POST',
                    //     body: JSON.stringify({
                    //         values: [Object.values(data)]
                    //     })
                    // });
                    
                    // Por ahora, solo guardamos localmente
                    saveToLocalStorage(data);
                    updateSyncStatus(true);
                    
                    return true;
                } catch (error) {
                    console.error('Error guardando en la nube:', error);
                    // Guardar localmente como respaldo
                    saveToLocalStorage(data);
                    updateSyncStatus(false);
                    return true; // Retornamos true porque se guard贸 localmente
                }
            }
            
            // Guardar en localStorage como respaldo
            function saveToLocalStorage(data) {
                database.push(data);
                localStorage.setItem('horasHombreDB', JSON.stringify(database));
                updateTotalRecordsDisplay();
            }
            
            // Cargar desde localStorage
            function loadFromLocalStorage() {
                const localData = localStorage.getItem('horasHombreDB');
                if (localData) {
                    database = JSON.parse(localData);
                    updateTotalRecordsDisplay();
                }
            }
            
            // Actualizar estado de sincronizaci贸n
            function updateSyncStatus(online) {
                isOnline = online;
                if (online) {
                    syncStatus.textContent = 'Sincronizado';
                    syncStatus.className = 'sync-status sync-online';
                    configStatus.textContent = 'Conectado a base de datos centralizada';
                } else {
                    syncStatus.textContent = 'Modo Offline';
                    syncStatus.className = 'sync-status sync-offline';
                    configStatus.textContent = 'Modo offline - usando almacenamiento local';
                }
            }
            
            // Actualizar display de 煤ltima sincronizaci贸n
            function updateLastSyncDisplay() {
                const now = new Date();
                const diffMs = now - lastSyncTime;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) {
                    lastSync.textContent = 'Hace unos segundos';
                } else if (diffMins === 1) {
                    lastSync.textContent = 'Hace 1 minuto';
                } else {
                    lastSync.textContent = `Hace ${diffMins} minutos`;
                }
            }
            
            // Actualizar display de total de registros
            function updateTotalRecordsDisplay() {
                totalRecords.textContent = `${database.length} registros`;
            }
            
            // ==============================
            // FUNCIONES EXISTENTES (modificadas)
            // ==============================
            
            // Funci贸n para poblar el select de empleados en consulta
            function populateEmployeeSelect() {
                consultEmployeeSelect.innerHTML = '<option value="">Todos los empleados</option>';
                
                for (const [id, nombre] of Object.entries(employees)) {
                    const option = document.createElement('option');
                    option.value = id;
                    option.textContent = `${id} - ${nombre}`;
                    consultEmployeeSelect.appendChild(option);
                }
            }
            
            // Funci贸n para verificar si una secci贸n tiene datos ingresados
            function sectionHasData(sectionId) {
                if (sectionId === 'section-ejecuciones') {
                    const orden = document.getElementById('orden').value;
                    const sufijo = document.getElementById('sufijo').value;
                    const operacion = document.getElementById('operacion').value;
                    const horaInicio = document.getElementById('hora-inicio-ejecuciones').value;
                    const horaFin = document.getElementById('hora-fin-ejecuciones').value;
                    
                    return orden || sufijo || operacion || horaInicio || horaFin;
                } else if (sectionId === 'section-indirectos') {
                    const actividad = document.getElementById('actividad').value;
                    const horaInicio = document.getElementById('hora-inicio-indirectos').value;
                    const horaFin = document.getElementById('hora-fin-indirectos').value;
                    
                    return actividad || horaInicio || horaFin;
                }
                return false;
            }
            
            // Funci贸n para actualizar el estado de las secciones
            function updateSectionStates() {
                ejecucionesHasData = sectionHasData('section-ejecuciones');
                indirectosHasData = sectionHasData('section-indirectos');
                
                // Actualizar indicadores visuales
                if (ejecucionesHasData) {
                    sectionIndirectos.classList.add('disabled');
                    lockEjecuciones.classList.remove('hidden');
                    sectionEjecuciones.classList.add('locked');
                } else {
                    sectionIndirectos.classList.remove('disabled');
                    lockEjecuciones.classList.add('hidden');
                    sectionEjecuciones.classList.remove('locked');
                }
                
                if (indirectosHasData) {
                    sectionEjecuciones.classList.add('disabled');
                    lockIndirectos.classList.remove('hidden');
                    sectionIndirectos.classList.add('locked');
                } else {
                    sectionEjecuciones.classList.remove('disabled');
                    lockIndirectos.classList.add('hidden');
                    sectionIndirectos.classList.remove('locked');
                }
            }
            
            // Funci贸n para consultar la base de datos
            function queryDatabase(filters) {
                let results = database;
                
                if (filters.employee) {
                    results = results.filter(record => record.empleado.id === filters.employee);
                }
                
                if (filters.type) {
                    results = results.filter(record => record.tipo === filters.type);
                }
                
                if (filters.date) {
                    results = results.filter(record => {
                        const recordDate = new Date(record.fecha).toISOString().split('T')[0];
                        return recordDate === filters.date;
                    });
                }
                
                return results;
            }
            
            // Funci贸n para mostrar notificaci贸n
            function showNotification(message, isError = false, isWarning = false) {
                notification.textContent = message;
                notification.classList.remove('error', 'warning');
                
                if (isError) {
                    notification.classList.add('error');
                } else if (isWarning) {
                    notification.classList.add('warning');
                }
                
                notification.classList.add('show');
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 3000);
            }
            
            // Funci贸n para mostrar resultados de consulta
            function displayResults(results) {
                resultsBody.innerHTML = '';
                
                if (results.length === 0) {
                    resultsTable.classList.add('hidden');
                    noResults.classList.remove('hidden');
                    return;
                }
                
                noResults.classList.add('hidden');
                resultsTable.classList.remove('hidden');
                
                results.forEach(record => {
                    const row = document.createElement('tr');
                    
                    // Formatear fecha
                    const date = new Date(record.fecha);
                    const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                    
                    // Formatear detalles seg煤n el tipo
                    let detalles = '';
                    if (record.tipo === 'ejecuciones') {
                        detalles = `Orden: ${record.orden}, Sufijo: ${record.sufijo}, Operaci贸n: ${record.operacion}`;
                    } else {
                        detalles = `Actividad: ${record.actividad}`;
                    }
                    
                    row.innerHTML = `
                        <td>${formattedDate}</td>
                        <td>${record.empleado.id} - ${record.empleado.nombre}</td>
                        <td>${record.tipo === 'ejecuciones' ? 'Ejecuciones' : 'Indirectos'}</td>
                        <td>${detalles}</td>
                        <td>${record.horaInicio}</td>
                        <td>${record.horaFin}</td>
                    `;
                    
                    resultsBody.appendChild(row);
                });
            }
            
            // Funci贸n para descargar Excel
            function downloadExcel() {
                if (database.length === 0) {
                    showNotification('No hay registros para descargar', true);
                    return;
                }
                
                // Crear libro de trabajo
                const wb = XLSX.utils.book_new();
                
                // Preparar datos para Excel
                const excelData = database.map(record => {
                    const date = new Date(record.fecha);
                    const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
                    
                    if (record.tipo === 'ejecuciones') {
                        return {
                            'Fecha': formattedDate,
                            'ID Empleado': record.empleado.id,
                            'Nombre Empleado': record.empleado.nombre,
                            'Tipo': 'Ejecuciones',
                            'Orden': record.orden,
                            'Sufijo': record.sufijo,
                            'Operaci贸n': record.operacion,
                            'Hora Inicio': record.horaInicio,
                            'Hora Fin': record.horaFin
                        };
                    } else {
                        return {
                            'Fecha': formattedDate,
                            'ID Empleado': record.empleado.id,
                            'Nombre Empleado': record.empleado.nombre,
                            'Tipo': 'Indirectos',
                            'Actividad': record.actividad,
                            'Hora Inicio': record.horaInicio,
                            'Hora Fin': record.horaFin
                        };
                    }
                });
                
                // Crear hoja de trabajo
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Agregar hoja al libro
                XLSX.utils.book_append_sheet(wb, ws, 'Registros Horas Hombre');
                
                // Descargar archivo
                XLSX.writeFile(wb, 'registros_horas_hombre.xlsx');
                showNotification('Excel descargado exitosamente');
            }
            
            // Funci贸n para borrar todos los registros
            function deleteAllRecords() {
                database = [];
                localStorage.removeItem('horasHombreDB');
                showNotification('Todos los registros han sido eliminados');
                
                // Actualizar la vista de resultados
                const results = queryDatabase({});
                displayResults(results);
                updateTotalRecordsDisplay();
                
                // Ocultar el prompt de contrase帽a
                passwordPrompt.classList.add('hidden');
                adminPasswordInput.value = '';
            }
            
            // ==============================
            // EVENT LISTENERS
            // ==============================
            
            // Detectar cuando se ingresa un ID de empleado
            employeeIdInput.addEventListener('input', function() {
                const code = this.value.trim().toUpperCase();
                
                if (employees[code]) {
                    employeeNameDiv.textContent = employees[code];
                    employeeNameDiv.classList.remove('hidden');
                } else {
                    employeeNameDiv.classList.add('hidden');
                }
            });
            
            // Permitir que el campo se limpie al presionar Escape
            employeeIdInput.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    this.value = '';
                    employeeNameDiv.classList.add('hidden');
                }
            });
            
            // Activar/desactivar secciones al hacer clic
            sectionEjecuciones.addEventListener('click', function() {
                if (this.classList.contains('disabled')) return;
                
                this.classList.add('active');
                sectionIndirectos.classList.remove('active');
            });
            
            sectionIndirectos.addEventListener('click', function() {
                if (this.classList.contains('disabled')) return;
                
                this.classList.add('active');
                sectionEjecuciones.classList.remove('active');
            });
            
            // Monitorear cambios en los campos de entrada
            const inputsEjecuciones = document.querySelectorAll('#section-ejecuciones input, #section-ejecuciones select');
            const inputsIndirectos = document.querySelectorAll('#section-indirectos input, #section-indirectos select');
            
            inputsEjecuciones.forEach(input => {
                input.addEventListener('input', updateSectionStates);
            });
            
            inputsIndirectos.forEach(input => {
                input.addEventListener('input', updateSectionStates);
            });
            
            // Cambiar pesta帽as
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Actualizar pesta帽as activas
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Actualizar contenido activo
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                });
            });
            
            // Registrar datos de ejecuciones
            btnRegistrarEjecuciones.addEventListener('click', async function() {
                const employeeId = employeeIdInput.value.trim().toUpperCase();
                
                if (!employees[employeeId]) {
                    alert('Por favor, ingrese un ID de empleado v谩lido');
                    return;
                }
                
                const orden = document.getElementById('orden').value;
                const sufijo = document.getElementById('sufijo').value;
                const operacion = document.getElementById('operacion').value;
                const horaInicio = document.getElementById('hora-inicio-ejecuciones').value;
                const horaFin = document.getElementById('hora-fin-ejecuciones').value;
                
                if (!orden || !sufijo || !operacion || !horaInicio || !horaFin) {
                    alert('Por favor, complete todos los campos de la secci贸n Ejecuciones');
                    return;
                }
                
                const data = {
                    tipo: 'ejecuciones',
                    empleado: {
                        id: employeeId,
                        nombre: employees[employeeId]
                    },
                    orden: orden,
                    sufijo: sufijo,
                    operacion: operacion,
                    horaInicio: horaInicio,
                    horaFin: horaFin,
                    fecha: new Date().toISOString()
                };
                
                // Guardar en la nube (con respaldo local)
                const success = await saveToCloud(data);
                
                if (success) {
                    const message = isOnline ? 
                        'Registro de ejecuciones guardado y sincronizado' : 
                        'Registro guardado localmente (modo offline)';
                    
                    showNotification(message, false, !isOnline);
                    
                    // Limpiar formulario
                    document.getElementById('orden').value = '';
                    document.getElementById('sufijo').value = '';
                    document.getElementById('operacion').value = '';
                    document.getElementById('hora-inicio-ejecuciones').value = '';
                    document.getElementById('hora-fin-ejecuciones').value = '';
                    
                    // Actualizar estado de secciones despu茅s de limpiar
                    updateSectionStates();
                } else {
                    alert('Error al guardar el registro. Intente nuevamente.');
                }
            });
            
            // Registrar datos de indirectos
            btnRegistrarIndirectos.addEventListener('click', async function() {
                const employeeId = employeeIdInput.value.trim().toUpperCase();
                
                if (!employees[employeeId]) {
                    alert('Por favor, ingrese un ID de empleado v谩lido');
                    return;
                }
                
                const actividad = document.getElementById('actividad').value;
                const horaInicio = document.getElementById('hora-inicio-indirectos').value;
                const horaFin = document.getElementById('hora-fin-indirectos').value;
                
                if (!actividad || !horaInicio || !horaFin) {
                    alert('Por favor, complete todos los campos de la secci贸n Indirectos');
                    return;
                }
                
                const data = {
                    tipo: 'indirectos',
                    empleado: {
                        id: employeeId,
                        nombre: employees[employeeId]
                    },
                    actividad: actividad,
                    horaInicio: horaInicio,
                    horaFin: horaFin,
                    fecha: new Date().toISOString()
                };
                
                // Guardar en la nube (con respaldo local)
                const success = await saveToCloud(data);
                
                if (success) {
                    const message = isOnline ? 
                        'Registro de indirectos guardado y sincronizado' : 
                        'Registro guardado localmente (modo offline)';
                    
                    showNotification(message, false, !isOnline);
                    
                    // Limpiar formulario
                    document.getElementById('actividad').value = '';
                    document.getElementById('hora-inicio-indirectos').value = '';
                    document.getElementById('hora-fin-indirectos').value = '';
                    
                    // Actualizar estado de secciones despu茅s de limpiar
                    updateSectionStates();
                } else {
                    alert('Error al guardar el registro. Intente nuevamente.');
                }
            });
            
            // Consultar registros
            btnConsultar.addEventListener('click', function() {
                const employee = document.getElementById('consult-employee').value;
                const type = document.getElementById('consult-type').value;
                const date = document.getElementById('consult-date').value;
                
                const filters = {
                    employee: employee,
                    type: type,
                    date: date
                };
                
                const results = queryDatabase(filters);
                displayResults(results);
            });
            
            // Descargar Excel
            btnDownloadExcel.addEventListener('click', downloadExcel);
            
            // Sincronizar ahora
            btnSyncNow.addEventListener('click', async function() {
                showNotification('Sincronizando...', false, true);
                const success = await syncWithGoogleSheets();
                if (success) {
                    showNotification('Sincronizaci贸n completada');
                    // Actualizar resultados si estamos en la pesta帽a de consulta
                    const results = queryDatabase({});
                    displayResults(results);
                } else {
                    showNotification('Error en sincronizaci贸n', true);
                }
            });
            
            // Probar conexi贸n
            btnTestConnection.addEventListener('click', async function() {
                showNotification('Probando conexi贸n...', false, true);
                const success = await syncWithGoogleSheets();
                if (success) {
                    showNotification('Conexi贸n exitosa');
                } else {
                    showNotification('Error de conexi贸n', true);
                }
            });
            
            // Crear backup
            btnBackupNow.addEventListener('click', function() {
                downloadExcel();
                showNotification('Backup creado exitosamente');
            });
            
            // Mostrar prompt para borrar registros
            btnDeleteRecords.addEventListener('click', function() {
                if (database.length === 0) {
                    showNotification('No hay registros para eliminar', true);
                    return;
                }
                passwordPrompt.classList.remove('hidden');
            });
            
            // Cancelar eliminaci贸n
            btnCancelDelete.addEventListener('click', function() {
                passwordPrompt.classList.add('hidden');
                adminPasswordInput.value = '';
            });
            
            // Confirmar eliminaci贸n
            btnConfirmDelete.addEventListener('click', function() {
                const password = adminPasswordInput.value;
                
                if (password === 'Admin0000') {
                    deleteAllRecords();
                } else {
                    showNotification('Contrase帽a incorrecta', true);
                    adminPasswordInput.value = '';
                }
            });
            
            // Permitir confirmar con Enter
            adminPasswordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    btnConfirmDelete.click();
                }
            });
            
            // Cargar todos los registros al abrir la pesta帽a de consulta por primera vez
            document.querySelector('.tab[data-tab="consulta"]').addEventListener('click', function() {
                if (resultsBody.children.length === 0) {
                    const results = queryDatabase({});
                    displayResults(results);
                }
            });
            
            // ==============================
            // INICIALIZACIN
            // ==============================
            
            // Inicializar la aplicaci贸n
            async function initializeApp() {
                // Cargar datos iniciales
                await syncWithGoogleSheets();
                
                // Inicializar el estado de las secciones y poblar el select de empleados
                updateSectionStates();
                populateEmployeeSelect();
                
                // Actualizar displays
                updateLastSyncDisplay();
                updateTotalRecordsDisplay();
                
                // Configurar actualizaci贸n peri贸dica de la hora de sincronizaci贸n
                setInterval(updateLastSyncDisplay, 60000); // Cada minuto
                
                // Sincronizaci贸n autom谩tica cada 5 minutos
                setInterval(async () => {
                    if (isOnline) {
                        await syncWithGoogleSheets();
                    }
                }, 300000); // 5 minutos
            }
            
            // Iniciar la aplicaci贸n
            initializeApp();
        });
    </script>
</body>
</html>
